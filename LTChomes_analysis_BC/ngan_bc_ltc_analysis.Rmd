---
title: "bc_ltc_analysis"
author: "Ngan Lyle"
date: "21/08/2020"
output: html_document
---

## Import and prepare the data
```{r results="hide"}
library(skimr)

# Import the data
# df <- read.csv("../data/BC/ngan_bcLTC_foranalysis.csv", na.strings="", header=TRUE)
# str(df)

df <- read.csv("../data/BC/bc_ltc_selected.csv", na.strings="", header=TRUE)
str(df)

```

```{r, echo=FALSE}
# Change data type to character
listofcol = list('FACILITY_NAME', 'HCC_CODE', 'STREET_ADDRESS', 'CITY', 'POSTAL')
for (each in listofcol){
  df[, each] <- as.character(df[, each])
}

df$outbreak <- as.factor(df$outbreak)
str(df)
colnames(df)
```

```{r, include=FALSE}
# # Generate the data for analysis
# # Create lists of variables used to filter data for analysis

num <- c("BEDS_TOTAL", "BEDS_PRIVATEprop", "ROOMS_PRIVATE", "ROOMS_SEMI", "ROOMS_MULTI")
cat <- c("HLTH_AUTH", "OWNERSHIP", "REGULATION", "ACCRED_STATUS", "RESIDENT_COUNCIL", "FAMILY_COUNCIL")
data <- subset(df, select = c(num, cat, 'outbreak'))


# incidents = c(
#   
#   # "INCIDENT_OUTBREAK", "INCIDENT_ABUSE", "INCIDENT_FALL",
#   # "INCIDENT_POISON", "INCIDENT_MEDICATION", "INCIDENT_WANDERING",
#   # "INCIDENT_INJURY", "INCIDENT_AGGRESSION", 
#   
#   "INCIDENT_OUTBREAK_100",
#   "INCIDENT_ABUSE_100", "INCIDENT_FALL_100", "INCIDENT_POISON_100",
#   "INCIDENT_MEDICATION_100", "INCIDENT_WANDERING_100", "INCIDENT_INJURY_100",
#   "INCIDENT_AGGRESSION_100")
# 
# inspections = c("COMPLAINTS", "SUB_COMPLAINTS", "INSPECTIONS", "INFRACTIONS",
#   "INFRACTIONS_LICENSING",
#   "INFRACTIONS_LICENSING", "INFRACTIONS_FACILITY", "INFRACTIONS_STAFFING",
#   "INFRACTIONS_POLICY", "INFRACTIONS_CARE", "INFRACTIONS_DISEASE",
#   "INFRACTIONS_FOOD", "INFRACTIONS_MEDICATION", "INFRACTIONS_PROGRAM",
#   "INFRACTIONS_REPORTING", "INFRACTIONS_RIGHTS", "INFRACTIONS_OTHER")
# 
# gen = c("OWNERSHIP", "REGULATION", "ACCRED_STATUS", "CMI", "facility_design",
#   "RESIDENT_COUNCIL", "FAMILY_COUNCIL")
# 
# dch = c("DCH_NURSE_CURRENTYR", "DCH_ALLIED_CURRENTYR", "DCH_TOTAL_CURRENTYR")
# 
# space = c("BEDS_PRIVATE", "BEDS_PUBLIC", "BEDS_TOTAL",
#   "ROOMS_PRIVATE", "ROOMS_SEMI", "ROOMS_MULTI",
#   "BEDS_PRIVATEprop", "BEDS_PUBLICprop", "ROOMS_TOTAL",
#   "ROOMS_PRIVATEprop", "ROOMS_SEMIprop", "ROOMS_MULTIprop")
# 
# data <- subset(df, select = c(gen, incidents, inspections, dch, space, 'outbreak'))
# 
str(data)
```



```{r, }
## Assessing skewness
# Check for R skewness in numeric predictors
library(e1071)


listofcols = c(num)

for (each in listofcols){
  print(each)
  print(skewness(data[[each]]))
  qqnorm(data[[each]], main = each)
  qqline(data[[each]], col = 'red')
}

# listofcols = c(incidents, inspections, "CMI", dch, space)
# 
# for (each in listofcols){
#   print(each)
#   print(skewness(data[[each]]))
#   qqnorm(data[[each]], main = each)
#   qqline(data[[each]], col = 'red')
# }

```


All the data are right skewed except for 
  1. BEDS_PUBLICprop 3.430426
  2. ROOMS_PRIVATEprop -1.486055

```{r, include=FALSE}
# Assess variables for 0s
for (each in listofcols){
  print(each)
  print(summary(df[[each]]))
}

```

Most numeric variables have 0s except for:
- CMI
- all DCH variables
- BEDS_PUBLIC, 1.142218
- BEDS_TOTAL, 1.03226
- ROOMS_PRIVATE, 0.944784
- BEDS_PUBLICprop, 3.430426 highly L skewed
- ROOMS_TOTAL, 1.103714
- ROOMS_PRIVATEprop, -1.486055 slightly R skewed

## Explore the variables for transformation
```{r, fig.show="hide"}

# Create a list of right skewed numeric variables with 0 values
list_non0s = c('BEDS_TOTAL')
list0s = c("ROOMS_PRIVATE", "ROOMS_SEMI", "ROOMS_MULTI",
  "BEDS_PRIVATEprop")


# # Create a list of right skewed numeric variables with 0 values
# space_non0s = c('BEDS_PUBLIC', 'BEDS_TOTAL', 'ROOMS_PRIVATE', 'ROOMS_TOTAL')
# space_0s = c("BEDS_PRIVATE", "ROOMS_SEMI", "ROOMS_MULTI",
#   "BEDS_PRIVATEprop", "ROOMS_SEMIprop", "ROOMS_MULTIprop")
# 
# list0s <- c(incidents, inspections, space_0s)
# list_non0s <- c(space_non0s, dch, 'CMI')
# left_skewed <- c('BEDS_PUBLICprop', 'ROOMS_PRIVATEprop')

library(rcompanion)
# listofcols <- setdiff(listofcols, list0s)

# Visualize the effect of square root transformations on the data with 0s
for (each in c(list0s, list_non0s)) {  
  plotNormalHistogram(x = data[[each]], main = each)
  plotNormalHistogram(x = sqrt(data[[each]]), main = c(each, 'sqrt trans'))
}

# Visualize the effect of log transformations on the data with no 0s that are right skewed
for (each in list_non0s) {  
  plotNormalHistogram(x = data[[each]], main = each)
  plotNormalHistogram(x = log(data[[each]]), main = c(each, 'log trans'))
}

Visualize the effect of transformations on the data that are left skewed
# log10(max(x+1) - x)
plotNormalHistogram(x = data[['BEDS_PUBLICprop']])
plotNormalHistogram(x = sqrt(max(data[['BEDS_PUBLICprop']] + 1) - data[['BEDS_PUBLICprop']]))

# # sqrt(max(x+1) - x)
# plotNormalHistogram(x = data[['ROOMS_PRIVATEprop']])
# plotNormalHistogram(x = sqrt(max(data[['ROOMS_PRIVATEprop']] + 1) - data[['ROOMS_PRIVATEprop']]))

```
Sqrt transformation is best for all the data.


## Transform the data
```{r }
# list0s
# # Sqrt transform in place
# data[list0s] <- log(data[list0s])

# Square root transform in place
data[num] <- sqrt(data[num])

skim(data)
```

## Fit logistic regression
```{r }
# Fit logistic regression using transformed data
fit = glm(outbreak~., family=binomial, data=data)
summary(fit)
```

### Backwards selection
```{r, include=FALSE}
fit <- update(fit, .~. -HLTH_AUTH)
summary(fit)
fit <- update(fit, .~. -ACCRED_STATUS)
summary(fit)
fit <- update(fit, .~. -OWNERSHIP)
summary(fit)
fit <- update(fit, .~. -REGULATION)
summary(fit)
fit <- update(fit, .~. -BEDS_PRIVATEprop)
summary(fit)
fit <- update(fit, .~. -ROOMS_PRIVATE  )
summary(fit)
fit <- update(fit, .~. -ROOMS_MULTI)
summary(fit)
fit <- update(fit, .~. -RESIDENT_COUNCIL)
summary(fit)
# fit <- update(fit, .~. -ROOMS_SEMI)
# summary(fit)

```

```{r }

```

```{r }

```

```{r }

```

