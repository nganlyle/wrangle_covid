---
title: "bc_ltc_analysis"
author: "Ngan Lyle"
date: "21/08/2020"
output: html_document
---

## Import and prepare the data
```{r results="hide"}
library(skimr)
library(dplyr)

# Import the data
# selected data
df <- read.csv("../data/BC/bc_ltc_selected.csv", na.strings="", header=TRUE)

# Remove the 3 homes that are considered "Special Units"
df <- df %>%
  filter(!grepl('Special Unit', FACILITY_NAME))

str(df)
```

```{r, echo=FALSE}
# Change datatypes as needed
listofcol = list('FACILITY_NAME', 'HCC_CODE', 'STREET_ADDRESS', 'CITY', 'POSTAL')

for (each in listofcol){
  df[, each] <- as.character(df[, each])
}

df$outbreak <- as.factor(df$outbreak)

# str(df)
dput(names(df))
```

```{r, include=FALSE}
# # Generate the data for analysis
# # Create lists of variables used to filter data for analysis

# # selected data
# num <- c("BEDS_TOTAL", "BEDS_PRIVATEprop", "ROOMS_PRIVATE", "ROOMS_SEMI", "ROOMS_MULTI")
# cat <- c("HLTH_AUTH", "OWNERSHIP", "REGULATION", "ACCRED_STATUS", "RESIDENT_COUNCIL", "FAMILY_COUNCIL")
# data <- subset(df, select = c(num, cat, 'outbreak'))

# noNHorVIHA data
incidents = c(
  "INCIDENT_OUTBREAK_100",
  "INCIDENT_ABUSE_100", "INCIDENT_FALL_100", "INCIDENT_POISON_100",
  "INCIDENT_MEDICATION_100", "INCIDENT_WANDERING_100",
  "INCIDENT_INJURY_100", "INCIDENT_AGGRESSION_100"
  )

inspections = c(
  "COMPLAINTS", "SUB_COMPLAINTS", "INSPECTIONS",
  "INFRACTIONS",
  "INFRACTIONS_DISEASE")

gen = c("OWNERSHIP", "REGULATION", "ACCRED_STATUS","RESIDENT_COUNCIL", "FAMILY_COUNCIL")

dch = c(
  "DCH_NURSE_LASTYR",
  "DCH_ALLIED_LASTYR",
  "DCH_NURSE_CURRENTYR",
  "DCH_ALLIED_CURRENTYR"
 )

space = c("BEDS_PRIVATEprop", "BEDS_TOTAL",
  "ROOMS_PRIVATE", "ROOMS_SEMI", "ROOMS_MULTI")

dem = c(
  "AGE", "FEMALE",
  "AGE_85_PLUS", "AGE_UNDER_65", "DEPRESSION", "ADL_DEPENDENT",
  "CPS_SEVERE", "DEMENTIA", "ABS_PHYS_ABUSIVE", "ISE_LOW", "CMI",
  "THERAPY_PT", "THERAPY_RT", "THERAPY_OT", "MEDS_DEPRESSION",
  "MEDS_ANTIPSYCHOTICS", "RESTRAINTS"
)

data <- subset(df, select = c(gen, incidents, inspections, dch, space, 'outbreak'))

str(data)

```



```{r, }
## Assessing skewness
# Check for R skewness in numeric predictors
library(e1071)

listofcol = c(num)

for (each in listofcol){
  print(each)
  print(skewness(data[[each]]))
  qqnorm(data[[each]], main = each)
  qqline(data[[each]], col = 'red')
}

```

```{r, include=FALSE}
# Assess variables for 0s
for (each in listofcol){
  print(each)
  print(summary(df[[each]]))
}

```

All the variables above have 0s except for BEDS_TOTAL so will square root transform

## Explore the variables for transformation
```{r, fig.show="hide"}
library(rcompanion)

# Visualize the effect of square root transformations on the  predictors
for (each in listofcol) {  
  plotNormalHistogram(x = data[[each]], main = each)
  plotNormalHistogram(x = sqrt(data[[each]]), main = c(each, 'sqrt trans'))
}

# # Visualize the effect of log transformations on the data with no 0s that are right skewed
# for (each in list_non0s) {  
#   plotNormalHistogram(x = data[[each]], main = each)
#   plotNormalHistogram(x = log(data[[each]]), main = c(each, 'log trans'))
# }

# Visualize the effect of transformations on the data that are left skewed
# # log10(max(x+1) - x)
# plotNormalHistogram(x = data[['BEDS_PUBLICprop']])
# plotNormalHistogram(x = sqrt(max(data[['BEDS_PUBLICprop']] + 1) - data[['BEDS_PUBLICprop']]))

# # sqrt(max(x+1) - x)
# plotNormalHistogram(x = data[['ROOMS_PRIVATEprop']])
# plotNormalHistogram(x = sqrt(max(data[['ROOMS_PRIVATEprop']] + 1) - data[['ROOMS_PRIVATEprop']]))

```
Sqrt transformation is best for all the data.

## Transform the data
```{r }
# list0s
# # Sqrt transform in place
# data[list0s] <- log(data[list0s])

# Square root transform in place
data[listofcol] <- sqrt(data[listofcol])

skim(data)
```

## Fit logistic regression
```{r }
# Fit logistic regression using transformed data
fit = glm(outbreak~., family=binomial, data=data)
summary(fit)
```

### Backwards selection
```{r, include=FALSE}
fit <- update(fit, .~. -HLTH_AUTH)
summary(fit)
fit <- update(fit, .~. -ACCRED_STATUS)
summary(fit)
fit <- update(fit, .~. -OWNERSHIP)
summary(fit)
fit <- update(fit, .~. -REGULATION)
summary(fit)
fit <- update(fit, .~. -BEDS_PRIVATEprop)
summary(fit)
fit <- update(fit, .~. -ROOMS_PRIVATE  )
summary(fit)
fit <- update(fit, .~. -ROOMS_MULTI)
summary(fit)
fit <- update(fit, .~. -RESIDENT_COUNCIL)
summary(fit)
fit <- update(fit, .~. -ROOMS_SEMI)
summary(fit)

```

```{r }
# Most homes have a family_council
# 8/46 homes without a family council had an outbreak
# 26/251 with a family council had an outbreak
xtabs(~outbreak + FAMILY_COUNCIL, data=df)

# Review the minority of homes without a family council
subset(df, FAMILY_COUNCIL == 'False')
```

```{r }

```

```{r }

```
