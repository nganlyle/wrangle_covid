---
title: "BC LTC Analysis"
author: "KT Hobbs"
date: "02/08/2020"
output:
  html_document: default
  pdf_document: default
---

## Import and prepare the data
```{r results="hide"}
library(skimr)

# Import the data
df <- read.csv("../data/BC/bc_ltc_complete_kt.csv", na.strings="", header=TRUE)
colnames(df)
```
Remove homes with suppressed data (4) and special units (3) as they are included as part of a major building already.

```{r}
rmv <- c(# suppressed data
              "Bella Coola General Hospital", "Mackenzie and District Hospital and Health Centre",
                "Northern Haida Gwaii Hospital and Health Centre", "R. W. Large Memorial Hospital",
              
         # special care units
               "Berkley Care Centre - Special Unit", "Fair Haven - Vancouver - Special Unit",
              "Harmony Court Care Centre  - Special Unit")

df2 <- df[-which(df$FACILITY_NAME %in% rmv),]

# remove granular infractions
df2 <- df2[, -grep('^INFRACTIONS_.', colnames(df2))]

# remove incidents that are NOT per 100 beds
colnames(df2)
df2 <- df2[, -c(22:29, 30:37)]
```


```{r}
# assess age
pairs(df2[,c(22,24:25)])
# remove AGE as AGE_85_PLUS describes the same trend
```

```{r}
# assess councils
cor(df2[,c(48:49)])
```

```{r}
# drop unneccessary columns
dr <- c(#"FACILITY_NAME", - keep for data quality analysis
        "HCC_CODE", "STREET_ADDRESS", "CITY", "POSTAL", # deemed irrelevant to inquiry
        "COMPLAINTS", # substantiated complaints are more telling
       "DCH_NURSE_LASTYR", "DCH_ALLIED_LASTYR", "DCH_TOTAL_LASTYR",
       "DCH_NURSE_CURRENTYR", "DCH_ALLIED_CURRENTYR", "DCH_TOTAL_CURRENTYR", 
       "THERAPY_PT", "THERAPY_RT", "THERAPY_OT", "RESTRAINTS",
       "ISE", # high multicollinearity
       "latitude", "longitude",
       "AGE", # redundant - from pairs plot
       "Total.Confirmed.Cases", "Total.Deaths" # focus on outbreak status first
       )

df2 <- df2[, -which(names(df2) %in% dr)]

```

```{r}
# dataframe without health authority - 
df3 <- df2[, c(1, 3:length(df2))]
names(df3)
```


### Cleaning
  * Convert `FEMALE` and `AGE` variables to numeric (from factor) decimals
  * Convert NAs to "unknown"
  * Bin `FEMALE` and `AGE` variables

```{r suppressMessages = TRUE}
df3$FEMALE <- as.numeric(gsub("[\\%,]", "", df3$FEMALE))/100
df3$AGE_85_PLUS <- as.numeric(gsub("[\\%,]", "", df3$AGE_85_PLUS))/100
df3$AGE_UNDER_65 <- as.numeric(gsub("[\\%,]", "", df3$AGE_UNDER_65))/100


library(arules)
# FEMALE
levels(discretize(df3$FEMALE, method = "interval", breaks = 3))

# convert NAs
df3$FEMALE <- replace_na(df3$FEMALE, "unknown")

df3[df3$FEMALE < 0.45,]$FEMALE <- "<0.45"
df3[df3$FEMALE > 0.45 & df3$FEMALE < 0.7,]$FEMALE <- "0.45-0.7"
df3[df3$FEMALE > 0.7 & df3$FEMALE < 0.95,]$FEMALE <- "0.7-0.95"



# AGE_85_PLUS
levels(discretize(df3$AGE_85_PLUS, method = "interval", breaks = 3))

# convert nas
df3$AGE_85_PLUS <- replace_na(df3$AGE_85_PLUS, "unknown")

df3[df3$AGE_85_PLUS < 0.34,]$AGE_85_PLUS <- "<0.34"
df3[df3$AGE_85_PLUS < 0.67 & df3$AGE_85_PLUS >= 0.34,]$AGE_85_PLUS <- "0.34-0.67"
df3[df3$AGE_85_PLUS <= 1 & df3$AGE_85_PLUS >= 0.67,]$AGE_85_PLUS <- "0.67-1"



# AGE_UNDER_65
levels(discretize(df3$AGE_UNDER_65, method = "interval", breaks = 3))

# convert nas
df3$AGE_UNDER_65 <- replace_na(df3$AGE_UNDER_65, "unknown")

df3[df3$AGE_UNDER_65 < 0.3,]$AGE_UNDER_65 <- "<0.3"
df3[df3$AGE_UNDER_65 < 0.63 & df3$AGE_UNDER_65 >= 0.3,]$AGE_UNDER_65 <- "0.3-0.63"
df3[df3$AGE_UNDER_65 <= 0.94 & df3$AGE_UNDER_65 > 0.63,]$AGE_UNDER_65 <- "0.67-0.94"


```


  * Convert resident profile information to numeric
  * Convert`STAY_LENGTH`, `SUB_COMPLAINTS` to numeric
  
```{r}
# profile <- c("DEPRESSION", "ADL_DEPENDENT", "CPS_SEVERE", "DEMENTIA", "ABS_PHYS_ABUSIVE", 
            # "ISE_LOW", "MEDS_DEPRESSION", "MEDS_ANTIPSYCHOTICS")


df3$DEPRESSION <- as.numeric(gsub("[\\%,]", "", df3$DEPRESSION))/100
df3$ADL_DEPENDENT <- as.numeric(gsub("[\\%,]", "", df3$ADL_DEPENDENT))/100
df3$CPS_SEVERE <- as.numeric(gsub("[\\%,]", "", df3$CPS_SEVERE))/100
df3$DEMENTIA <- as.numeric(gsub("[\\%,]", "", df3$DEMENTIA))/100
df3$ABS_PHYS_ABUSIVE <- as.numeric(gsub("[\\%,]", "", df3$ABS_PHYS_ABUSIVE))/100
df3$ISE_LOW <- as.numeric(gsub("[\\%,]", "", df3$ISE_LOW))/100
df3$MEDS_DEPRESSION <- as.numeric(gsub("[\\%,]", "", df3$MEDS_DEPRESSION))/100
df3$MEDS_ANTIPSYCHOTICS <- as.numeric(gsub("[\\%,]", "", df3$MEDS_ANTIPSYCHOTICS))/100
```



```{r}
df3$STAY_LENGTH <- as.numeric(as.character(df3$STAY_LENGTH))
df3$SUB_COMPLAINTS <- as.numeric(as.character(df3$SUB_COMPLAINTS))
```

### Assess NAs

```{r}
colSums(is.na.data.frame(df3))
``````



# Binary Logistic Regression

Remove `FACILITY_NAME`

```{r}
df4 <- df3[,-1]
names(df4)
```

NAs will be omitted by default
```{r}
fit = glm(outbreak~., family=binomial, data=df4, maxit = 25)

```

## Removing all other homes with NAs
```{r}
df5 <- df4[-rowSums(is.na.data.frame(df4)),]

fit2 = glm(outbreak~., family=binomial, data=df5, maxit = 25)
summary(fit2)
```



---
## Separating hospitals and LTCs

```{r}
hospitals <- subset(df4, df4$REGULATION == "Hospital Act")
ltcs <- subset(df4, df4$REGULATION == "Community Care & Assisted Living Act")

paste('hospital dimensions: ', dim(hospitals))
paste('ltc dimensions: ', dim(ltcs))

```

```{r hospitals}
colSums(is.na.data.frame(hospitals))
hospitals[rowSums(is.na.data.frame(hospitals)),]
```

```{r ltcs}
colSums(is.na.data.frame(ltcs))
ltcs[rowSums(is.na.data.frame(ltcs)),]

```

```{r}

```

