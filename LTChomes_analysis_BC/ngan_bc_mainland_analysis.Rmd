---
title: "bc_mainland_analysis"
author: "Ngan Lyle"
date: "28/08/2020"
output: html_document
---
## Import and prepare the data
```{r results="hide"}
library(skimr)
library(dplyr)

# Import the data
df <- read.csv("../data/BC/ngan_bc_ltc_mainland_sel.csv", na.strings="", header=TRUE)
str(df)

```


```{r, echo=FALSE}
# Change datatypes as needed
listofcol = list('FACILITY_NAME', 'HCC_CODE')
for (each in listofcol){
  df[, each] <- as.character(df[, each])
}

listofcol = list('RESIDENT_COUNCIL', 'FAMILY_COUNCIL', 'BEDS_PRIVATEbinary', 'rooms_shared', 'outbreak', 'hospital_act', 'community_act', 'ROOMS_SEMIbinary', 'ROOMS_MULTIbinary')
for (each in listofcol){
  df[, each] <- as.factor(df[, each])
}

# df$outbreak <- as.factor(df$outbreak)

str(df)
# dput(names(df))
```

```{r, include=FALSE}
# # Generate the data for analysis
# # Create lists of variables used to filter data for analysis

num <- c(
  "BEDS_TOTAL", 
  "COMPLAINTS", 
  "SUB_COMPLAINTS", 
  "AGE", 
  "FEMALE", 
  "ISE_LOW", 
  "CMI", 
  "INSPECTIONS", 
  "INFRACTIONS", 
  "INCIDENTS_100sum",
  "DCH_NURSE",
  "DCH_ALLLIED",
  "DCH_TOTAL",
  "BEDS_PRIVATEprop")

cat <- c(
  "HLTH_AUTH", 
  "OWNERSHIP", 
  "REGULATION", 
  "ACCRED_STATUS",
  "RESIDENT_COUNCIL", 
  "FAMILY_COUNCIL",
  "BEDS_PRIVATEbinary", 
  "rooms_shared",
  "community_act", 
  "hospital_act", 
  "ROOMS_SEMIbinary", 
  "ROOMS_MULTIbinary")

data <- subset(df, select = c(num, cat, 'outbreak'))

str(data)
```

```{r, }
## Assessing skewness
# Check for R skewness in numeric predictors
library(e1071)

for (each in num){
  print(each)
  print(skewness(data[[each]]))
  # qqnorm(data[[each]], main = each)
  # qqline(data[[each]], col = 'red')
}

```

We see above that most of the numeric predictors are right skewed to various degrees. 
  - Highly right skewed for skewness values > 1. 
  - Mildly right skewed for skewness values between 0 and 1

There are some left skewed predictors:

[1] "AGE"
[1] -4.35839
[1] "FEMALE"
[1] -1.039271
[1] "ADL_DEPENDENT"
[1] -0.03933123
[1] "DEMENTIA"
[1] -1.643361
[1] "ISE_LOW"
[1] -0.3928765
[1] "MEDS_DEPRESSION"
[1] -0.2032298

We explore the variables to assess for zero values prior to transformation. 

```{r, }
# Assess numeric predictors for 0s
for (each in num){
  print(each)
  print(summary(df[[each]]))
}
```

## Explore the variables for transformation
```{r, }
# Create a list of numeric variables with 0 values
list_non0s <- c(

  'AGE',
  'FEMALE',
  'DEPRESSION',
  'ISE_LOW',
  'CMI',
  'BEDS_TOTAL',
  'DCH_NURSE',
  'DCH_ALLLIED',
  'DCH_TOTAL'
)

list_0s <- setdiff(num, list_non0s)

library(rcompanion)

# Visualize the effect of square root and log transformations on the data without 0s
for (each in list_non0s) {  
  plotNormalHistogram(x = data[[each]], main = each)
  plotNormalHistogram(x = sqrt(data[[each]]), main = c(each, 'sqrt trans'))
  plotNormalHistogram(x = log(data[[each]]), main = c(each, 'log trans'))
}

```


```{r, }
# Visualize the effect of a square root transformation on the variables with 0s
for (each in list_0s) {  
  plotNormalHistogram(x = data[[each]], main = each)
  plotNormalHistogram(x = sqrt(data[[each]]), main = c(each, 'sqrt trans'))
}

```

## Transform the data
```{r }

# list_non0s <- c(
#   'DCH_NURSE_LASTYR',
#   'DCH_ALLIED_LASTYR',
#   'DCH_TOTAL_LASTYR',
#   'DCH_NURSE_CURRENTYR',
#   'DCH_ALLIED_CURRENTYR',
#   'DCH_TOTAL_CURRENTYR',
#   'AGE',
#   # 'FEMALE',
#   # 'DEPRESSION',
#   # 'ADL_DEPENDENT',
#   # 'ISE_LOW',
#   'CMI',
#   # 'MEDS_DEPRESSION',
#   # 'MEDS_ANTIPSYCHOTICS',
#   # 'BEDS_TOTAL'
# )

# Log transform in place
# data[c(
#   'DCH_NURSE_LASTYR',
#   'DCH_ALLIED_LASTYR',
#   'DCH_TOTAL_LASTYR',
#   'DCH_NURSE_CURRENTYR',
#   'DCH_ALLIED_CURRENTYR',
#   'DCH_TOTAL_CURRENTYR',
#   'AGE',
#   # 'FEMALE',
#   # 'DEPRESSION',
#   # 'ADL_DEPENDENT',
#   # 'ISE_LOW',
#   'CMI'
#   # 'MEDS_DEPRESSION',
#   # 'MEDS_ANTIPSYCHOTICS',
#   # 'BEDS_TOTAL'
# )] <- log(data[c(
#   'DCH_NURSE_LASTYR',
#   'DCH_ALLIED_LASTYR',
#   'DCH_TOTAL_LASTYR',
#   'DCH_NURSE_CURRENTYR',
#   'DCH_ALLIED_CURRENTYR',
#   'DCH_TOTAL_CURRENTYR',
#   'AGE',
#   # 'FEMALE',
#   # 'DEPRESSION',
#   # 'ADL_DEPENDENT',
#   # 'ISE_LOW',
#   'CMI'
#   # 'MEDS_DEPRESSION',
#   # 'MEDS_ANTIPSYCHOTICS',
#   # 'BEDS_TOTAL'
# )])

list_0s_sqrt <- setdiff(list_0s, c('CPS_SEVERE',
'ABS_PHYS_ABUSIVE',
'AGE',
'Dementia'))

# Square root transform in place
data[c(list_0s)] <- sqrt(data[c(list_0s)])

skim(data)

```

sqrt
DEPRESSION
MEDS_ANTIPSYCHOTICS
BEDS_TOTAL

none
FEMALE
ISE_LOW
ADL_DEPENDENT
MEDS_DEPRESSION

0s
CPS_SEVERE
ABS_PHYS_ABUSIVE

left
AGE
Dementia

## Fit logistic regression
```{r }
# Fit logistic regression using transformed data
fit = glm(outbreak~., family=binomial, data=data)
summary(fit)
```



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
