---
title: "ltc_analysis_ON_share"
output: html_document
---

## Import and prepare the data
```{r }
library(skimr)

# Import the data
df <- read.csv("../data_output/merged_LTC_odhf_quality.csv", na.strings="", header=TRUE)
# skim(df)
# head(df)

# Change variable data types
df[, 'outbreak'] <- as.factor(df[, 'outbreak'])

listofcol = list('first_inspection_date', 'date_first_outbreak', 'date_max_cases', 'date_max_HCWcases', 'date_first_resolved')
for (each in listofcol){
  df[, each] <- as.Date(df[, each])
}

listofcol = list('name', 'cleaned_name', 'address', 'city', 'postal_code', 'CSDname')
for (each in listofcol){
  df[, each] <- as.character(df[, each])
}

skim(df)

```

## Determine number years since the first inspection for each home
```{r, results='hide'}
# Create a new column for first inspection year
df$first_inspection_year <- format(df$first_inspection_date,"%Y")
df$first_inspection_year <- as.numeric(df$first_inspection_year)

# Earliest date of first inspection was in 2009 and latest date was 2016
summary(df[['first_inspection_year']])

# Create a new column with number of years since the first inspection was reported
df$years_since_first <- 2020 - df$first_inspection_year
# summary(df[['years_since_first']])

# There is only 1 home with fewer than 5 years of inspections -> Royal Rose Place
table(df['years_since_first'])
subset(df, years_since_first == 4)
```



### Normalize the number of inspections
```{r, results='hide'}

# Number of inspections/beds
df$total_inspections_norm <- df$total_inspections/df$number_beds/df$years_since_first
df$X5y_inspections_norm <- df$X5y_inspections/df$number_beds/5
df[293, "X5y_inspections_norm"] <- df[293, "X5y_inspections_norm"]*5/4
df$X2y_inspections_norm <- df$X2y_inspections/df$number_beds/2

# Number of withOrders/beds
df$total_withOrders_norm <- df$total_withOrders/df$number_beds/df$years_since_first
df$X5y_withOrders_norm <- df$X5y_withOrders/df$number_beds/5
df[293, "X5y_withOrders_norm"] <- df[293, "X5y_withOrders_norm"]*5/4
df$X2y_withOrders_norm <- df$X2y_withOrders/df$number_beds/2

# Drop un-normalized inspections data
df <- df[,-c(21:32)]

# dput(names(df))

skim(df)
```


```{r, }
# Generate the data for analysis
# Create lists of variables used to filter data for analysis

outcomes = c(
  "outbreak", 
  "cum_resident_deaths", 
  "max_resident_cases", 
  "max_hcw_cases"
  )

profile = c(
  "home_type", 
  "number_beds", 
  "short_stay", 
  "residents_council", 
  "family_council", 
  "accreditation"
  )

location = c(
  'address', 
  'LHIN', 
  'city', 
  'postal_code', 
  'CSDname', 
  'CSDuid', 
  'latitude', 
  'longitude')

inspections_total = c(
  'total_inspections_norm',
  'total_withOrders_norm'
)

inspections_5y = c(
    'X5y_inspections_norm'
  , "X5y_withOrders_norm"
  )

inspections_2y = c(
    'X2y_inspections_norm'
  , "X2y_withOrders_norm"
  )

inspections = c(inspections_2y, inspections_5y, inspections_total)

```

## Analysis with all 625 homes (exclude Quality data)
```{r }
data <- subset(df, select = c('outbreak', profile, inspections))
skim(data)
# View(colnames(data))
# dput(names(df))

```

## Fit logistic regression
```{r }
# fit logistic regression 
fit = glm(outbreak~., family='binomial', data=data)
summary(fit)

```

LASSO 
```{r }
# https://stats.stackexchange.com/questions/72251/an-example-lasso-regression-using-glmnet-for-binary-outcome
library(glmnet)
# library(caret)
options(max.print=999999)

# model.matrix() automatically transforms any qualitative variables into dummy variables
# Trim the first column leaving only predictors
x = model.matrix(outbreak~., data = data)[,-1]
y <- as.factor(data.matrix(data[,1]))

# Note alpha=1 for lasso only, and can blend with ridge penalty
# alpha=0 ridge only
glmmod <- glmnet(x, y, family = 'binomial')

# glmmod$call
# summary(glmmod)
# plot(glmmod, xvar = 'lambda', label = TRUE)
# plot(glmmod, xvar = 'dev', label = TRUE)
coef(glmmod)

```
As lambda decreases, the order that covariates are added to the model:
    
    1. number_beds
    2. home_typeMunicipal
    3. total_inspections_normshort_stayYes
    4. family_councilYes
    5. accreditationYes
    6. X2y_withOrders_norm
    7. X2y_inspections_norm
    8. home_typeNon-Profit 
    

LASSO - CV
```{r }
cv.glmmod <- cv.glmnet(x, y, alpha=1, family = 'binomial')
plot(cv.glmmod)
plot(cv.glmmod$glmnet.fit, label = TRUE, xvar = "lambda")
plot(cv.glmmod$glmnet.fit, label = TRUE, xvar = "dev")

coef(cv.glmmod)
coef(cv.glmmod, s = "lambda.min")

```

```{r }
data_lr <- subset(df, select = c('outbreak',
                                 'number_beds',
                                 'home_type',
                                 'short_stay',
                                 'family_council',
                                 'residents_council',
                                 'accreditation',
                                 
                                 # 'total_inspections_norm',
                                 'X2y_withOrders_norm',
                                 'X2y_inspections_norm'
                                 ))


fit = glm(outbreak~., family='binomial', data=data_lr)
summary(fit)
```



