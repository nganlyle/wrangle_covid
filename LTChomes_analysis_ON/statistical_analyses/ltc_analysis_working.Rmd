---
title: "ltc_analysis_ON"
author: "Ngan Lyle"
date: "08/09/2020"
output: html_document
---
## Import and prepare the data
```{r }
library(skimr)

# Import the data
df <- read.csv("../data_output/merged_LTC_odhf_quality.csv", na.strings="", header=TRUE)
# skim(df)
# head(df)

# Change variable data types
df[, 'outbreak'] <- as.factor(df[, 'outbreak'])

listofcol = list('first_inspection_date', 'date_first_outbreak', 'date_max_cases', 'date_max_HCWcases', 'date_first_resolved')
for (each in listofcol){
  df[, each] <- as.Date(df[, each])
}

listofcol = list('name', 'cleaned_name', 'address', 'city', 'postal_code', 'CSDname')
for (each in listofcol){
  df[, each] <- as.character(df[, each])
}

skim(df)

```


```{r, results='hide'}
# Create a new column for first inspection year
df$first_inspection_year <- format(df$first_inspection_date,"%Y")
df$first_inspection_year <- as.numeric(df$first_inspection_year)

# Earliest date of first inspection was in 2009 and latest date was 2016
summary(df[['first_inspection_year']])

# Create a new column with number of years since the first inspection was reported
df$years_since_first <- 2020 - df$first_inspection_year
# summary(df[['years_since_first']])

# There is only 1 home with fewer than 5 years of inspections, Royal Rose Place
table(df['years_since_first'])
subset(df, years_since_first == 4)
```

### Normalize the number of inspections
```{r, results='hide'}
# Number of inspections/beds
df$total_inspections_norm <- df$total_inspections/df$number_beds/df$years_since_first
df$X5y_inspections_norm <- df$X5y_inspections/df$number_beds/5
df[293, "X5y_inspections_norm"] <- df[293, "X5y_inspections_norm"]*5/4
df$X2y_inspections_norm <- df$X2y_inspections/df$number_beds/2

# # Number of complaints/beds
# df$total_complaints_norm <- df$total_complaints/df$number_beds/df$years_since_first
# df$X5y_complaints_norm <- df$X5y_complaints/df$number_beds/5
# df[293, "X5y_complaints_norm"] <- df[293, "X5y_complaints_norm"]*5/4
# df$X2y_complaints_norm <- df$X2y_complaints/df$number_beds/2
# 
# # Number of noncomplaints/beds
# df$total_noncomplaints_norm <- (df$total_inspections - df$total_complaints)/df$number_beds/df$years_since_first
# df$X5y_noncomplaints_norm <- (df$X5y_inspections - df$X5y_complaints)/df$number_beds/5
# df[293, "X5y_noncomplaints_norm"] <- df[293, "X5y_noncomplaints_norm"]*5/4
# df$X2y_noncomplaints_norm <- (df$X2y_inspections - df$X2y_complaints)/df$number_beds/2
# 
# # Number of critical/beds
# df$total_critical_norm <- df$total_critical/df$number_beds/df$years_since_first
# df$X5y_critical_norm <- df$X5y_critical/df$number_beds/5
# df[293, "X5y_critical_norm"] <- df[293, "X5y_critical_norm"]*5/4
# df$X2y_critical_norm <- df$X2y_critical/df$number_beds/2
# 
# # Number of non-critical/beds
# df$total_noncritical_norm <- (df$total_inspections - df$total_critical)/df$number_beds/df$years_since_first
# df$X5y_noncritical_norm <- (df$X5y_inspections - df$X5y_critical)/df$number_beds/5
# df[293, "X5y_noncritical_norm"] <- df[293, "X5y_noncritical_norm"]*5/4
# df$X2y_noncritical_norm <- (df$X2y_inspections - df$X2y_critical)/df$number_beds/2

# Number of withOrders/beds
df$total_withOrders_norm <- df$total_withOrders/df$number_beds/df$years_since_first
df$X5y_withOrders_norm <- df$X5y_withOrders/df$number_beds/5
df[293, "X5y_withOrders_norm"] <- df[293, "X5y_withOrders_norm"]*5/4
df$X2y_withOrders_norm <- df$X2y_withOrders/df$number_beds/2

# # Number of non-withOrders/beds
# df$total_nonwithOrders_norm <- (df$total_inspections - df$total_withOrders)/df$number_beds/df$years_since_first
# df$X5y_nonwithOrders_norm <- (df$X5y_inspections - df$X5y_withOrders)/df$number_beds/5
# df[293, "X5y_nonwithOrders_norm"] <- df[293, "X5y_nonwithOrders_norm"]*5/4
# df$X2y_nonwithOrders_norm <- (df$X2y_inspections - df$X2y_withOrders)/df$number_beds/2


# View(colnames(df))
# Drop un-normalized inspections data
df <- df[,-c(21:32)]

df[293,]

```

```{r, }
skim(df)
```

```{r, include=FALSE}
dput(names(df))
```


```{r, }
# Generate the data for analysis
# Create lists of variables used to filter data for analysis

outcomes = c(
  "outbreak", 
  "cum_resident_deaths", 
  "max_resident_cases", 
  "max_hcw_cases"
  )

profile = c(
  "home_type", 
  "number_beds", 
  "short_stay", 
  "residents_council", 
  "family_council", 
  "accreditation"
  )
location = c(
  'address', 
  'LHIN', 
  'city', 
  'postal_code', 
  'CSDname', 
  'CSDuid', 
  'latitude', 
  'longitude')

qual = c(
  "antipsychotic_percent", 
  "pressure_ulcers_percent", 
  "falls_percent", 
  "restraints_percent", 
  "depression_percent", 
  "pain_percent"
  )

inspections = c(
  "total_inspections_norm", 
  "X5y_inspections_norm", 
  "X2y_inspections_norm" 
  )

# complaints = c("total_complaints_norm"
#   , "X5y_complaints_norm"
#   , "X2y_complaints_norm"
#   , "total_noncomplaints_norm"
#   , "X5y_noncomplaints_norm"
#   , "X2y_noncomplaints_norm"
#   )
# 
# critical = c("total_critical_norm"
#   , "X5y_critical_norm"
#   , "X2y_critical_norm"
#   , "total_noncritical_norm"
#   , "X5y_noncritical_norm"
#   , "X2y_noncritical_norm"
#   )

withOrders = c("total_withOrders_norm"
  , "X5y_withOrders_norm"
  , "X2y_withOrders_norm"
  # , "total_nonwithOrders_norm"
  # , "X5y_nonwithOrders_norm"
  # , "X2y_nonwithOrders_norm"
  
  )

```

## Analysis with all 625 homes (exclude Quality data)
```{r }
data <- subset(df, select = c('outbreak', profile, withOrders, inspections))
skim(data)
# View(colnames(data))
# dput(names(df))

```

## Fit logistic regression
```{r }
# fit logistic regression 
fit = glm(outbreak~., family='binomial', data=data)
summary(fit)

```


LASSO
```{r }
# https://stats.stackexchange.com/questions/72251/an-example-lasso-regression-using-glmnet-for-binary-outcome
library(glmnet)
# library(caret)
options(max.print=999999)

# model.matrix() automatically transforms any qualitative variables into dummy variables
# Trim the first column leaving only predictors
x = model.matrix(outbreak~., data = data)[,-1]
y <- as.factor(data.matrix(data[,1]))

# Note alpha=1 for lasso only, and can blend with ridge penalty
# alpha=0 ridge only
glmmod <- glmnet(x, y, family = 'binomial')

# glmmod$call
# summary(glmmod)
# plot(glmmod, xvar = 'lambda', label = TRUE)
# plot(glmmod, xvar = 'dev', label = TRUE)
coef(glmmod)

```
As lambda decreases, the order that covariates are added to the model:
    
    1. number_beds
    2. home_typeMunicipal
    3. total_inspections_norm
    4. short_stayYes
    5. family_councilYes
    6. accreditationYes
    7. X2y_withOrders_norm
    8. X2y_inspections_norm, residents_councilYes


```{r, include=FALSE}
# lambda_min <- cv.glmmod$lambda.min
# lambda_1se <- cv.glmmod$lambda.1se

# cv.glmmod.auc <- cv.glmnet(x, y, alpha=1, family = 'binomial', type.measure = "auc")
# coef(cv.glmmod.auc, s = "lambda.min")
# plot(cv.glmmod.auc)
# plot(cv.glmmod.auc$glmnet.fit, label = T, xvar = "lambda")
# plot(cv.glmmod.auc$glmnet.fit, label = T, xvar = "dev")
# 
# cv.glmmod.class <- cv.glmnet(x, y, alpha=1, family = 'binomial', type.measure = "class")
# coef(cv.glmmod.class, s = "lambda.min")
# plot(cv.glmmod.class)
# plot(cv.glmmod.class$glmnet.fit, label = T, xvar = "lambda")

# # Lasso model with suggested lambda values
# glmmod_min <- glmnet(x, y, alpha = 1, family = 'binomial', lambda = lambda_min)
# glmmod_1se <- glmnet(x, y, alpha = 1, family = 'binomial', lambda = lambda_1se)
# coef(glmmod_min)
# coef(glmmod_1se)
```

LASSO - CV
```{r }
cv.glmmod <- cv.glmnet(x, y, alpha=1, family = 'binomial')
plot(cv.glmmod)
plot(cv.glmmod$glmnet.fit, label = TRUE, xvar = "lambda")
plot(cv.glmmod$glmnet.fit, label = TRUE, xvar = "dev")

coef(cv.glmmod)
coef(cv.glmmod, s = "lambda.min")

```

  
# Fit logistic regression with selected covariates
```{r }
data_lr <- subset(df, select = c('outbreak'
                                 , 'number_beds'
                                 , 'home_type'
                                 , 'short_stay'
                                 , 'family_council'
                                 , 'residents_council'
                                 , 'accreditation'

                                 , "X2y_inspections_norm"
                                 , "X2y_withOrders_norm"
                                 
                                 ))


fit = glm(outbreak~., family='binomial', data=data_lr)
summary(fit)
```
# Analyses with the Quality data (615/625 homes)
```{r }
data <- subset(df, select = c('outbreak', profile, qual, all_inspections))

# Remove 10 homes with missing quality data
data <- na.omit(data)
skim(data)

# View(colnames(data))
# dput(names(df))
```
## Fit logistic regression
```{r }
# fit logistic regression 
fit = glm(outbreak~., family='binomial', data=data)
summary(fit)

```
LASSO
```{r }

x <- model.matrix(outbreak~., data = data)[,-1]
y <- as.factor(data.matrix(data[,1]))

glmmod <- glmnet(x, y, family = 'binomial')
# glmmod$call
# summary(glmmod)
# plot(glmmod, xvar = 'lambda', label = TRUE)
# plot(glmmod, xvar = 'dev', label = TRUE)
coef(glmmod)

```
As lambda decreases, the order that covariates are added to the model:
    
    1. number_beds
    2. pain_percent
    2. X2y_critical_norm
    3. home_typeMunicipal
    4. short_stayYes
    5. total_complaints_norm
    6. X2y_withOrders_norm, family_councilYes
    7. restraints_percent
    8. falls_percent 
    9. antipsychotic_percent, X2y_complaints_norm, total_noncomplaints_norm, X5y_noncomplaints_norm


LASSO - CV
```{r }
cv.glmmod <- cv.glmnet(x, y, alpha=1, family = 'binomial')
plot(cv.glmmod)
plot(cv.glmmod$glmnet.fit, label = TRUE, xvar = "lambda")
plot(cv.glmmod$glmnet.fit, label = TRUE, xvar = "dev")

coef(cv.glmmod)
coef(cv.glmmod, s = "lambda.min")

```

# Fit logistic regression with selected covariates
```{r }
data_lr <- subset(data, select = c('outbreak',
                                 'number_beds',
                                 'pain_percent',
                                 'restraints_percent',
                                 'falls_percent',
                                 'antipsychotic_percent',
                                 'home_type',
                                 'short_stay',
                                 'family_council',
                                 'accreditation',
                                 'X2y_complaints_norm',
                                 'X2y_critical_norm',
                                 'X2y_withOrders_norm'
                                 ))

fit = glm(outbreak~., family='binomial', data=data_lr)
summary(fit)
```


```{r, eval=FALSE, include=FALSE }
library(MASS)
null <- glm(outbreak ~ 1, family = "binomial", data=data) # 1 here means the intercept 
# full <- glm(outbreak ~ home_type + number_beds + short_stay +
#     residents_council + family_council + accreditation + 
#     total_inspections_norm + X5y_inspections_norm + X2y_inspections_norm + 
#     total_noncomplaints_norm + X5y_noncomplaints_norm + X2y_noncomplaints_norm + 
#     total_complaints_norm + X5y_complaints_norm + X2y_complaints_norm, 
#   family = 'binomial', data = data)
# 
# full <- glm(outbreak ~ home_type + number_beds + short_stay +
#     residents_council + family_council + accreditation + 
#     total_noncomplaints_norm + X5y_noncomplaints_norm + X2y_noncomplaints_norm + 
#     total_complaints_norm + X5y_complaints_norm + X2y_complaints_norm, 
#   family = 'binomial', data = data)

full <- glm(outbreak ~ home_type + number_beds + short_stay +
    residents_council + family_council + accreditation + 
    # total_inspections_norm + 
    # X5y_inspections_norm + X2y_inspections_norm + 
    total_complaints_norm +
    # X5y_complaints_norm + 
    # X2y_complaints_norm +
    total_noncomplaints_norm
    # + X5y_noncomplaints_norm
    # + X2y_noncomplaints_norm
    ,
  family = 'binomial', data = data)

stepAIC(full, scope=list(lower=null, upper=full), data=data, direction='backward')
# stepAIC(null, scope=list(lower=null, upper=full), data=data, direction='forward')
# stepAIC(full, k = log(nrow(data)))
```

## Fit logistic regression
```{r, eval=FALSE, include=FALSE }
# fit logistic regression using transformed data
fit = glm(outbreak~., family='binomial', data=data_lr)
fit_recent = glm(outbreak~., family='binomial', data=data_lr_recent)
summary(fit)
summary(fit_recent)
```

## Backwards selection
```{r, eval=FALSE, include=FALSE}
# Manual
fit <- update(fit, .~. -total_inspections_norm)
summary(fit)
fit <- update(fit, .~. -X2y_inspections_norm)
summary(fit)
fit <- update(fit, .~. -X5y_inspections_norm)
summary(fit)
fit <- update(fit, .~. -X2y_complaints_norm)
summary(fit)
fit <- update(fit, .~. -X2y_noncomplaints_norm)
summary(fit)
fit <- update(fit, .~. -X5y_complaints_norm)
summary(fit)
fit <- update(fit, .~. -total_noncomplaints_norm)
summary(fit)
fit <- update(fit, .~. -X5y_noncomplaints_norm)
summary(fit)
fit <- update(fit, .~. -family_council)
summary(fit)
fit <- update(fit, .~. -accreditation)
summary(fit)
fit <- update(fit, .~. -residents_council)
summary(fit)
fit <- update(fit, .~. -short_stay)
summary(fit)
fit <- update(fit, .~. -X2y_noncomplaints_norm)
summary(fit)
fit <- update(fit, .~. -total_complaints_norm)
summary(fit)

```


## Transforming the Predictors
```{r, eval=FALSE, include=FALSE}
## Assessing skewness
# Check for R skewness in numeric predictors
library(e1071)

listofcols = c('number_beds', complaints, noncomplaints, all_inspections)

for (each in listofcols){
  print(each)
  print(skewness(data[[each]]))
  qqnorm(data[[each]], main = each)
  qqline(data[[each]], col = 'red')
}

for (each in listofcols){
  print(each)
  print(summary(df[[each]]))
}

# Create a list of numeric variables with 0 values
list0s <- c(complaints, "X2y_noncomplaints_norm")

library(rcompanion)
listofcols <- setdiff(listofcols, list0s)

# Visualize the effect of square root and log transformations on the data without 0s
for (each in listofcols) {  
  plotNormalHistogram(x = data[[each]], main = each)
  plotNormalHistogram(x = sqrt(data[[each]]), main = c(each, 'sqrt trans'))
  plotNormalHistogram(x = log(data[[each]]), main = c(each, 'log trans'))
}

# Visualize the effect of a square root transformation on the variables with 0s
for (each in list0s) {  
  plotNormalHistogram(x = data[[each]], main = each)
  plotNormalHistogram(x = sqrt(data[[each]]), main = c(each, 'sqrt trans'))
}

# Log transform in place

data[c("total_noncomplaints_norm", "X5y_noncomplaints_norm", all_inspections)] <- log(data[c("total_noncomplaints_norm", "X5y_noncomplaints_norm", all_inspections)])

# Square root transform in place
data[c('number_beds', list0s)] <- sqrt(data[c('number_beds', list0s)])

skim(data)
```

```{r, eval=FALSE, include=FALSE }
# Calculate McFadden's pseudo R2
ll.null <- fit$null.deviance/-2
ll.proposed <- fit$deviance/-2
print((ll.null - ll.proposed)/ll.null)
1 - pchisq(2*(ll.proposed - ll.null), df = (length(fit$coefficients)-1)) #pvalue

```

## Visualize the model
```{r, eval=FALSE, include=FALSE}
# Create a new dataframe showing probability of outbreak and outbreak status
predicted.data <- data.frame(probability.of.outbreak=fit$fitted.values, outbreak=data$outbreak)

# Sort the above df
predicted.data <- predicted.data[order(predicted.data$probability.of.outbreak, decreasing=FALSE),]

# Add new col to df with rank
predicted.data$rank <- 1:nrow(predicted.data)

library(ggplot2)
# library(cowplot)

ggplot(data = predicted.data, aes(x=rank, y=probability.of.outbreak)) +
  geom_point(aes(color=outbreak), alpha = 0.5, shape = 4, stroke = 1) +
  xlab("Index") + ylab("Predicted probability of an outbreak") +
  ggtitle("Outbreak Status Ordered By Predicted Probability of an Outbreak") + 
  scale_color_manual(values = c('blue', 'red'))

```


```{r }

```


```{r }

```


```{r }

```
